
<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PEP 680 – tomllib: Support for Parsing TOML in the Standard Library | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png"/>
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/mq.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <meta name="description" content="Python Enhancement Proposals (PEPs)"/>
</head>
<body>
    <section id="pep-page-section">
        <header>
            <h1>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 680 – tomllib: Support for Parsing TOML in the Standard Library</li>
            </ul>
        </header>
        <article>
            <section id="pep-content">
<h1 class="page-title">PEP 680 – tomllib: Support for Parsing TOML in the Standard Library</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">PEP</dt>
<dd class="field-odd">680</dd>
<dt class="field-even">Title</dt>
<dd class="field-even">tomllib: Support for Parsing TOML in the Standard Library</dd>
<dt class="field-odd">Author</dt>
<dd class="field-odd">Taneli Hukkinen, Shantanu Jain &lt;hauntsaninja at gmail.com&gt;</dd>
<dt class="field-even">Sponsor</dt>
<dd class="field-even">Petr Viktorin &lt;encukou&#32;&#97;t&#32;gmail.com&gt;</dd>
<dt class="field-odd">Discussions-To</dt>
<dd class="field-odd"><a class="reference external" href="https://discuss.python.org/t/13040">https://discuss.python.org/t/13040</a></dd>
<dt class="field-even">Status</dt>
<dd class="field-even">Draft</dd>
<dt class="field-odd">Type</dt>
<dd class="field-odd">Standards Track</dd>
<dt class="field-even">Created</dt>
<dd class="field-even">01-Jan-2022</dd>
<dt class="field-odd">Python-Version</dt>
<dd class="field-odd">3.11</dd>
<dt class="field-even">Post-History</dt>
<dd class="field-even">11-Jan-2022</dd>
</dl>
<hr class="docutils" />
<section id="contents">
<h2>Contents</h2>
<ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#specification">Specification</a></li>
<li><a class="reference internal" href="#maintenance-implications">Maintenance Implications</a><ul>
<li><a class="reference internal" href="#stability-of-toml">Stability of TOML</a></li>
<li><a class="reference internal" href="#maintainability-of-proposed-implementation">Maintainability of proposed implementation</a></li>
<li><a class="reference internal" href="#toml-support-a-slippery-slope-for-other-things">TOML support a slippery slope for other things</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#security-implications">Security Implications</a></li>
<li><a class="reference internal" href="#how-to-teach-this">How to Teach This</a></li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
<li><a class="reference internal" href="#rejected-ideas">Rejected Ideas</a><ul>
<li><a class="reference internal" href="#basing-on-another-toml-implementation">Basing on another TOML implementation</a></li>
<li><a class="reference internal" href="#including-an-api-for-writing-toml">Including an API for writing TOML</a></li>
<li><a class="reference internal" href="#assorted-api-details">Assorted API details</a><ul>
<li><a class="reference internal" href="#types-accepted-by-the-first-argument-of-tomllib-load">Types accepted by the first argument of <code class="docutils literal notranslate"><span class="pre">tomllib.load</span></code></a></li>
<li><a class="reference internal" href="#type-accepted-by-the-first-argument-of-tomllib-loads">Type accepted by the first argument of <code class="docutils literal notranslate"><span class="pre">tomllib.loads</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#controlling-the-type-of-mappings-returned-by-tomllib-load-s">Controlling the type of mappings returned by <code class="docutils literal notranslate"><span class="pre">tomllib.load[s]</span></code></a></li>
<li><a class="reference internal" href="#removing-support-for-parse-float-in-tomllib-load-s">Removing support for <code class="docutils literal notranslate"><span class="pre">parse_float</span></code> in <code class="docutils literal notranslate"><span class="pre">tomllib.load[s]</span></code></a></li>
<li><a class="reference internal" href="#alternative-names-for-module">Alternative names for module</a></li>
</ul>
</li>
<li><a class="reference internal" href="#previous-discussion">Previous Discussion</a></li>
<li><a class="reference internal" href="#appendix-a-differences-between-proposed-api-and-toml">Appendix A: Differences between proposed API and <code class="docutils literal notranslate"><span class="pre">toml</span></code></a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract">Abstract</a></h2>
<p>This proposes adding a module, <code class="docutils literal notranslate"><span class="pre">tomllib</span></code>, to the standard library for
parsing TOML (Tom’s Obvious Minimal Language,
<a class="reference external" href="https://toml.io/en/">https://toml.io</a>).</p>
</section>
<section id="motivation">
<h2><a class="toc-backref" href="#motivation">Motivation</a></h2>
<p>The TOML format is the format of choice for Python packaging, as evidenced by
<span class="target" id="index-0"></span><a class="pep reference external" href="pep-0517.html"><strong>PEP 517</strong></a>, <span class="target" id="index-1"></span><a class="pep reference external" href="pep-0518.html"><strong>PEP 518</strong></a> and <span class="target" id="index-2"></span><a class="pep reference external" href="pep-0621.html"><strong>PEP 621</strong></a>. Including TOML support in the standard
library helps avoid bootstrapping problems for Python build tools. Currently
most Python build tools need to vendor a TOML parsing library.</p>
<p>Python tools are increasingly configurable via TOML, for examples: <code class="docutils literal notranslate"><span class="pre">black</span></code>,
<code class="docutils literal notranslate"><span class="pre">mypy</span></code>, <code class="docutils literal notranslate"><span class="pre">pytest</span></code>, <code class="docutils literal notranslate"><span class="pre">tox</span></code>, <code class="docutils literal notranslate"><span class="pre">pylint</span></code>, <code class="docutils literal notranslate"><span class="pre">isort</span></code>. Those that are not, such
as <code class="docutils literal notranslate"><span class="pre">flake8</span></code>, cite the lack of standard library support as a <a class="reference external" href="https://github.com/PyCQA/flake8/issues/234#issuecomment-812800657">main reason why</a>.</p>
<p>Given the special place TOML already has in the Python ecosystem, it makes sense
for this to be an included battery.</p>
<p>Finally, TOML as a format is increasingly popular (some reasons for this are
outlined in <a class="reference external" href="pep-0518.html">PEP 518</a>). Hence this is likely to be a generally useful addition,
even looking beyond the needs of Python packaging and Python tooling: various
Python TOML libraries have about 2000 reverse dependencies on PyPI. For
comparison, <code class="docutils literal notranslate"><span class="pre">requests</span></code> has about 28k reverse dependencies.</p>
</section>
<section id="rationale">
<h2><a class="toc-backref" href="#rationale">Rationale</a></h2>
<p>This PEP proposes basing the standard library support for reading TOML on the
third party library <code class="docutils literal notranslate"><span class="pre">tomli</span></code>
(<a class="reference external" href="https://github.com/hukkin/tomli">github.com/hukkin/tomli</a>).</p>
<p>Many projects have recently switched to using <code class="docutils literal notranslate"><span class="pre">tomli</span></code>, for example, <code class="docutils literal notranslate"><span class="pre">pip</span></code>,
<code class="docutils literal notranslate"><span class="pre">build</span></code>, <code class="docutils literal notranslate"><span class="pre">pytest</span></code>, <code class="docutils literal notranslate"><span class="pre">mypy</span></code>, <code class="docutils literal notranslate"><span class="pre">black</span></code>, <code class="docutils literal notranslate"><span class="pre">flit</span></code>, <code class="docutils literal notranslate"><span class="pre">coverage</span></code>,
<code class="docutils literal notranslate"><span class="pre">setuptools-scm</span></code>, <code class="docutils literal notranslate"><span class="pre">cibuildwheel</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">tomli</span></code> is actively maintained and well-tested. <code class="docutils literal notranslate"><span class="pre">tomli</span></code> is about 800 lines
of code with 100% test coverage and passes all tests in a test suite <a class="reference external" href="https://github.com/toml-lang/compliance/pull/8">proposed
as the official TOML compliance test suite</a>, as well as <a class="reference external" href="https://github.com/BurntSushi/toml-test">the more
established BurntSushi/toml-test suite</a>.</p>
</section>
<section id="specification">
<h2><a class="toc-backref" href="#specification">Specification</a></h2>
<p>A new module <code class="docutils literal notranslate"><span class="pre">tomllib</span></code> with the following functions will be added:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">:</span> <span class="n">SupportsRead</span><span class="p">[</span><span class="nb">bytes</span><span class="p">],</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">parse_float</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span> <span class="o">...</span>
<span class="k">def</span> <span class="nf">loads</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">parse_float</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span> <span class="o">...</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">tomllib.load</span></code> deserializes a binary file containing a
TOML document to a Python dict.
The <code class="docutils literal notranslate"><span class="pre">fp</span></code> argument must have a <code class="docutils literal notranslate"><span class="pre">read()</span></code> method with the same API as
<code class="docutils literal notranslate"><span class="pre">io.RawIOBase.read()</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">tomllib.loads</span></code> deserializes a str instance containing a TOML document
to a Python dict.</p>
<p><code class="docutils literal notranslate"><span class="pre">parse_float</span></code> is a function that takes a string representing a TOML float and
returns a Python object (similar to <code class="docutils literal notranslate"><span class="pre">parse_float</span></code> in <code class="docutils literal notranslate"><span class="pre">json.load</span></code>). For
example, a function returning a <code class="docutils literal notranslate"><span class="pre">decimal.Decimal</span></code> in cases where precision is
important. By default, TOML floats are represented as <code class="docutils literal notranslate"><span class="pre">float</span></code> type.</p>
<p>The returned object contains only basic Python objects (<code class="docutils literal notranslate"><span class="pre">str</span></code>, <code class="docutils literal notranslate"><span class="pre">int</span></code>,
<code class="docutils literal notranslate"><span class="pre">bool</span></code>, <code class="docutils literal notranslate"><span class="pre">float</span></code>, <code class="docutils literal notranslate"><span class="pre">datetime.{datetime,date,time}</span></code>, <code class="docutils literal notranslate"><span class="pre">list</span></code>, <code class="docutils literal notranslate"><span class="pre">dict</span></code> with
string keys), and the results of <code class="docutils literal notranslate"><span class="pre">parse_float</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">tomllib.TOMLDecodeError</span></code> is raised in the case of invalid TOML.</p>
<p>Note that this PEP does not propose <code class="docutils literal notranslate"><span class="pre">tomllib.dump</span></code> or <code class="docutils literal notranslate"><span class="pre">tomllib.dumps</span></code>
functions, see <a class="reference internal" href="#including-an-api-for-writing-toml">including an api for writing toml</a> for details.</p>
</section>
<section id="maintenance-implications">
<h2><a class="toc-backref" href="#maintenance-implications">Maintenance Implications</a></h2>
<section id="stability-of-toml">
<h3><a class="toc-backref" href="#stability-of-toml">Stability of TOML</a></h3>
<p>The release of TOML v1 in January 2021 indicates stability. Empirically, TOML
has proven to be a stable format even prior to the release of TOML v1. From the
<a class="reference external" href="https://github.com/toml-lang/toml/blob/master/CHANGELOG.md">changelog</a>, we
see TOML has had no major changes since April 2020 and has had two releases in
the last five years.</p>
<p>In the event of changes to the TOML specification, we could treat minor
revisions as bug fixes and update the implementation in place. In the event of
major breaking changes, we should preserve support for TOML v1.</p>
</section>
<section id="maintainability-of-proposed-implementation">
<h3><a class="toc-backref" href="#maintainability-of-proposed-implementation">Maintainability of proposed implementation</a></h3>
<p>The proposed implementation (<code class="docutils literal notranslate"><span class="pre">tomli</span></code>) is in pure Python, well tested and
weighs under 1000 lines of code. It is minimalist, offering a smaller API
surface area than other TOML implementations.</p>
<p>The author of <code class="docutils literal notranslate"><span class="pre">tomli</span></code> is willing to help integrate <code class="docutils literal notranslate"><span class="pre">tomli</span></code> into the standard
library and help maintain it, <a class="reference external" href="https://github.com/hukkin/tomli/issues/141#issuecomment-998018972">as per this post</a>.
Petr Viktorin has indicated willingness to maintain a read API,
<a class="reference external" href="https://discuss.python.org/t/adopting-recommending-a-toml-parser/4068/88">as per this post</a>.</p>
<p>Rewriting the parser in C is not deemed necessary at this time. It’s rare for
TOML parsing to be a bottleneck in applications. Users with higher performance
needs can use a third party library (as is already often the case with JSON,
despite a stdlib extension module).</p>
</section>
<section id="toml-support-a-slippery-slope-for-other-things">
<h3><a class="toc-backref" href="#toml-support-a-slippery-slope-for-other-things">TOML support a slippery slope for other things</a></h3>
<p>As discussed in motivations, TOML holds a special place in the Python ecosystem.
This chief reason to include TOML in the standard library does not apply to
other formats, such as YAML or MessagePack.</p>
<p>In addition, the simplicity of TOML can help serve as a dividing line, for
example, YAML is large and complicated.</p>
<p>Including an API for writing TOML may, however, be added in a future PEP.</p>
</section>
</section>
<section id="backwards-compatibility">
<h2><a class="toc-backref" href="#backwards-compatibility">Backwards Compatibility</a></h2>
<p>This proposal has no backwards compatibility issues within the stdlib, as it
describes a new module.
Any existing third-party module named <code class="docutils literal notranslate"><span class="pre">tomllib</span></code> will break, as
<code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">tomllib</span></code> will import standard library module.
However, <code class="docutils literal notranslate"><span class="pre">tomllib</span></code> is not registered on PyPI, so it is unlikely that such
a module is widely used.</p>
<p>Note that we avoid using the more straightforward name <code class="docutils literal notranslate"><span class="pre">toml</span></code>, to avoid
backwards compatibility implications for users who have pinned versions of the
current <code class="docutils literal notranslate"><span class="pre">toml</span></code> PyPI package. For more details, see <a class="reference internal" href="#alternative-names-for-module">alternative names for module</a>.</p>
</section>
<section id="security-implications">
<h2><a class="toc-backref" href="#security-implications">Security Implications</a></h2>
<p>Errors in the implementation could cause potential security issues.
The parser’s output is limited to simple data types; inability to load
arbitrary classes avoids security issues common in more “powerful” formats like
pickle and YAML. Also, the implementation will be in pure Python, which reduces
security issues endemic to C, such as buffer overflows.</p>
</section>
<section id="how-to-teach-this">
<h2><a class="toc-backref" href="#how-to-teach-this">How to Teach This</a></h2>
<p>The API of <code class="docutils literal notranslate"><span class="pre">tomllib</span></code> mimics that of other well-established file format
libraries, such as <code class="docutils literal notranslate"><span class="pre">json</span></code> and <code class="docutils literal notranslate"><span class="pre">pickle</span></code>. The lack of a <code class="docutils literal notranslate"><span class="pre">dump</span></code> function will
be explained in the documentation, with a link to relevant third-party libraries
(<code class="docutils literal notranslate"><span class="pre">tomlkit</span></code>, <code class="docutils literal notranslate"><span class="pre">tomli-w</span></code>, <code class="docutils literal notranslate"><span class="pre">pytomlpp</span></code>).</p>
</section>
<section id="reference-implementation">
<h2><a class="toc-backref" href="#reference-implementation">Reference Implementation</a></h2>
<p>The proposed implementation can be found at <a class="reference external" href="https://github.com/hukkin/tomli">https://github.com/hukkin/tomli</a></p>
</section>
<section id="rejected-ideas">
<h2><a class="toc-backref" href="#rejected-ideas">Rejected Ideas</a></h2>
<section id="basing-on-another-toml-implementation">
<h3><a class="toc-backref" href="#basing-on-another-toml-implementation">Basing on another TOML implementation</a></h3>
<p>Several potential alternative implementations exist:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">tomlkit</span></code> is well established, actively maintained and supports TOML v1. An
important difference is that <code class="docutils literal notranslate"><span class="pre">tomlkit</span></code> supports style roundtripping. As a
result, it has a more complex API and implementation (about 5x as much code as
<code class="docutils literal notranslate"><span class="pre">tomli</span></code>). Its author does not believe that <code class="docutils literal notranslate"><span class="pre">tomlkit</span></code> is a good choice for
the standard library.</li>
<li><code class="docutils literal notranslate"><span class="pre">toml</span></code> is a very widely used library. However, it is not actively
maintained, does not support TOML v1 and has several known bugs. Its API is
more complex than that of <code class="docutils literal notranslate"><span class="pre">tomli</span></code>. It has some very limited and mostly
unused ability to preserve style through an undocumented decoder API. It has
the ability to customise output style through a complicated encoder API. For
more details on API differences to this PEP, refer to <a class="reference internal" href="#appendix-a">Appendix A</a>.</li>
<li><code class="docutils literal notranslate"><span class="pre">pytomlpp</span></code> is a Python wrapper for the C++ project <code class="docutils literal notranslate"><span class="pre">toml++</span></code>. Pure Python
libraries are easier to maintain than extension modules.</li>
<li><code class="docutils literal notranslate"><span class="pre">rtoml</span></code> is a Python wrapper for the Rust project <code class="docutils literal notranslate"><span class="pre">toml-rs</span></code> and hence has
similar shortcomings to <code class="docutils literal notranslate"><span class="pre">pytomlpp</span></code>.
In addition, it does not support TOML v1.</li>
<li>Writing an implementation from scratch. It’s unclear what we would get from
this: <code class="docutils literal notranslate"><span class="pre">tomli</span></code> meets our needs and the author is willing to help with its
inclusion in the standard library.</li>
</ul>
</section>
<section id="including-an-api-for-writing-toml">
<h3><a class="toc-backref" href="#including-an-api-for-writing-toml">Including an API for writing TOML</a></h3>
<p>There are several reasons to not include an API for writing TOML:</p>
<p>The ability to write TOML is not needed for the use cases that motivate this
PEP: for core Python packaging use cases or for tools that need to read
configuration.</p>
<p>Use cases that involve editing TOML (as opposed to writing brand new TOML) are
better served by a style preserving library. TOML is intended as human-readable
and human-editable configuration, so it’s important to preserve human markup,
such as comments and formatting. This requires a parser whose output includes
style-related metadata, making it impractical to output plain Python types like
<code class="docutils literal notranslate"><span class="pre">str</span></code> and <code class="docutils literal notranslate"><span class="pre">dict</span></code>. Designing such an API is complicated.</p>
<p>But even without considering style preservation, there are too many degrees of
freedom in how to design a write API. For example, how much control to allow
users over output formatting, over serialization of custom types, and over input
and output validation. While there are reasonable choices on how to resolve
these, the nature of the standard library is such that one only gets one chance
to get things right.</p>
<p>Currently no CPython core developers have expressed willingness to maintain a
write API or sponsor a PEP that includes a write API. Since it is hard to change
or remove something in the standard library, it is safer to err on the side of
exclusion and potentially revisit later.</p>
<p>So, writing TOML is left to third-party libraries. If a good API and relevant
use cases for it are found later, it can be added in a future PEP.</p>
</section>
<section id="assorted-api-details">
<h3><a class="toc-backref" href="#assorted-api-details">Assorted API details</a></h3>
<section id="types-accepted-by-the-first-argument-of-tomllib-load">
<h4><a class="toc-backref" href="#types-accepted-by-the-first-argument-of-tomllib-load">Types accepted by the first argument of <code class="docutils literal notranslate"><span class="pre">tomllib.load</span></code></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">toml</span></code> library on PyPI allows passing paths (and lists of path-like
objects, ignoring missing files and merging the documents into a single object).
Doing this would be inconsistent with <code class="docutils literal notranslate"><span class="pre">json.load</span></code>, <code class="docutils literal notranslate"><span class="pre">pickle.load</span></code>, etc. If we
agree consistency with other stdlib modules is desirable, allowing paths is
somewhat out of scope for this PEP. This can easily and explicitly be worked
around in user code, or a third-party library.</p>
<p>The proposed API takes a binary file, while <code class="docutils literal notranslate"><span class="pre">toml.load</span></code> takes a text file and
<code class="docutils literal notranslate"><span class="pre">json.load</span></code> takes either. Using a binary file allows us to a) ensure utf-8 is
the encoding used, b) avoid incorrectly parsing single carriage returns as valid
TOML due to universal newlines.</p>
</section>
<section id="type-accepted-by-the-first-argument-of-tomllib-loads">
<h4><a class="toc-backref" href="#type-accepted-by-the-first-argument-of-tomllib-loads">Type accepted by the first argument of <code class="docutils literal notranslate"><span class="pre">tomllib.loads</span></code></a></h4>
<p>While <code class="docutils literal notranslate"><span class="pre">tomllib.load</span></code> takes a binary file, <code class="docutils literal notranslate"><span class="pre">tomllib.loads</span></code> takes
a text string. This may seem inconsistent at first.</p>
<p>Quoting TOML v1.0.0 specification:</p>
<blockquote>
<div>A TOML file must be a valid UTF-8 encoded Unicode document.</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">tomllib.loads</span></code> does not intend to load a TOML file, but rather the
document that the file stores. The most natural representation of
a Unicode document in Python is <code class="docutils literal notranslate"><span class="pre">str</span></code>, not <code class="docutils literal notranslate"><span class="pre">bytes</span></code>.</p>
<p>It is possible to add <code class="docutils literal notranslate"><span class="pre">bytes</span></code> support in the future if needed, but
we are not aware of any use cases for it.</p>
</section>
</section>
<section id="controlling-the-type-of-mappings-returned-by-tomllib-load-s">
<h3><a class="toc-backref" href="#controlling-the-type-of-mappings-returned-by-tomllib-load-s">Controlling the type of mappings returned by <code class="docutils literal notranslate"><span class="pre">tomllib.load[s]</span></code></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">toml</span></code> library on PyPI supports a <code class="docutils literal notranslate"><span class="pre">_dict</span></code> argument, which works
similarly to the <code class="docutils literal notranslate"><span class="pre">object_hook</span></code> argument in <code class="docutils literal notranslate"><span class="pre">json.load[s]</span></code>. There are several
uses of <code class="docutils literal notranslate"><span class="pre">_dict</span></code> found on <a class="reference external" href="https://grep.app">https://grep.app</a>, however, almost all of them are
passing <code class="docutils literal notranslate"><span class="pre">_dict=OrderedDict</span></code>, which should be unnecessary as of Python 3.7. We
found two instances of legitimate use: in one case, a custom class was passed
for friendlier KeyErrors, in another case, the custom class had several
additional lookup and mutation methods (e.g. to help resolve dotted keys).</p>
<p>Such an argument is not necessary for the core use cases outlined in the
motivation section. The absence of this can be pretty easily worked around using
a wrapper class, transformer function, or a third-party library. Finally,
support could be added later in a backward compatible way.</p>
</section>
<section id="removing-support-for-parse-float-in-tomllib-load-s">
<h3><a class="toc-backref" href="#removing-support-for-parse-float-in-tomllib-load-s">Removing support for <code class="docutils literal notranslate"><span class="pre">parse_float</span></code> in <code class="docutils literal notranslate"><span class="pre">tomllib.load[s]</span></code></a></h3>
<p>This option is not strictly necessary, since TOML floats are “IEEE 754 binary64
values”, which is <code class="docutils literal notranslate"><span class="pre">float</span></code> on most architectures. Using <code class="docutils literal notranslate"><span class="pre">decimal.Decimal</span></code>
thus allows users extra precision not promised by the TOML format. However, in
the author of <code class="docutils literal notranslate"><span class="pre">tomli</span></code>’s experience, this is useful in scientific and financial
applications. TOML-facing users may include non-developers who are not aware of
the limits of double-precision float.</p>
<p>There are also niche architectures where the Python <code class="docutils literal notranslate"><span class="pre">float</span></code> is not a IEEE-754
binary64. The <code class="docutils literal notranslate"><span class="pre">parse_float</span></code> argument allows users to achieve correct TOML
semantics even on such architectures.</p>
</section>
<section id="alternative-names-for-module">
<h3><a class="toc-backref" href="#alternative-names-for-module">Alternative names for module</a></h3>
<p>Ideally, we would be able to use the <code class="docutils literal notranslate"><span class="pre">toml</span></code> module name.</p>
<p>However, the <code class="docutils literal notranslate"><span class="pre">toml</span></code> package on PyPI is widely used, so there are backward
compatibility concerns. Since the standard library takes precedence over third
party packages, users who have pinned versions of <code class="docutils literal notranslate"><span class="pre">toml</span></code> would be broken when
upgrading Python versions by any API incompatibilities.</p>
<p>To further clarify, the user pins are the specific concern here. Even if we were
able to get control over the <code class="docutils literal notranslate"><span class="pre">toml</span></code> PyPI package and repurpose it as a
standard library backport, we would still break users who have pinned to
versions of the current <code class="docutils literal notranslate"><span class="pre">toml</span></code> package. This is unfortunate, since pinning
would likely be a common response to breaking changes introduced by repurposing
the <code class="docutils literal notranslate"><span class="pre">toml</span></code> package as a backport (that is incompatible with today’s <code class="docutils literal notranslate"><span class="pre">toml</span></code>).</p>
<p>There are several API incompatibilities between <code class="docutils literal notranslate"><span class="pre">toml</span></code> and the API proposed in
this PEP, listed in <a class="reference internal" href="#appendix-a">Appendix A</a>.</p>
<p>Finally, the <code class="docutils literal notranslate"><span class="pre">toml</span></code> package on PyPI is not actively maintained and <a class="reference external" href="https://github.com/uiri/toml/issues/361">we have
been unable to contact the author</a>,
so action here would likely have to be taken without the author’s consent.</p>
<p>This PEP proposes <code class="docutils literal notranslate"><span class="pre">tomllib</span></code>. This mirrors <code class="docutils literal notranslate"><span class="pre">plistlib</span></code> and <code class="docutils literal notranslate"><span class="pre">xdrlib</span></code> (two
other file format modules in the standard library), as well as several others
such as <code class="docutils literal notranslate"><span class="pre">pathlib</span></code>, <code class="docutils literal notranslate"><span class="pre">contextlib</span></code>, <code class="docutils literal notranslate"><span class="pre">graphlib</span></code>, etc.</p>
<p>Other considered names include:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">tomlparser</span></code>. This mirrors <code class="docutils literal notranslate"><span class="pre">configparser</span></code>, but is perhaps slightly less
appropriate if we include a write API in the future.</li>
<li><code class="docutils literal notranslate"><span class="pre">tomli</span></code>. This assumes we use <code class="docutils literal notranslate"><span class="pre">tomli</span></code> as the basis for implementation.</li>
<li><code class="docutils literal notranslate"><span class="pre">toml</span></code> under some namespace, such as <code class="docutils literal notranslate"><span class="pre">parser.toml</span></code>. However, this is
awkward, especially so since existing libraries like <code class="docutils literal notranslate"><span class="pre">json</span></code>, <code class="docutils literal notranslate"><span class="pre">pickle</span></code>,
<code class="docutils literal notranslate"><span class="pre">marshal</span></code>, <code class="docutils literal notranslate"><span class="pre">html</span></code> etc. would not be included in the namespace.</li>
</ul>
</section>
</section>
<section id="previous-discussion">
<h2><a class="toc-backref" href="#previous-discussion">Previous Discussion</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://bugs.python.org/issue40059">https://bugs.python.org/issue40059</a></li>
<li><a class="reference external" href="https://mail.python.org/pipermail/python-dev/2019-May/157405.html">https://mail.python.org/pipermail/python-dev/2019-May/157405.html</a></li>
<li><a class="reference external" href="https://mail.python.org/archives/list/python-ideas&#64;python.org/thread/IWJ3I32A4TY6CIVQ6ONPEBPWP4TOV2V7/">https://mail.python.org/archives/list/python-ideas&#64;python.org/thread/IWJ3I32A4TY6CIVQ6ONPEBPWP4TOV2V7/</a></li>
<li><a class="reference external" href="https://discuss.python.org/t/adopting-recommending-a-toml-parser/4068/84">https://discuss.python.org/t/adopting-recommending-a-toml-parser/4068/84</a></li>
<li><a class="reference external" href="https://github.com/hukkin/tomli/issues/141">https://github.com/hukkin/tomli/issues/141</a></li>
</ul>
</section>
<section id="appendix-a-differences-between-proposed-api-and-toml">
<span id="appendix-a"></span><h2><a class="toc-backref" href="#appendix-a-differences-between-proposed-api-and-toml">Appendix A: Differences between proposed API and <code class="docutils literal notranslate"><span class="pre">toml</span></code></a></h2>
<p>This appendix covers the differences between the API proposed in this PEP and
that of the third party package <code class="docutils literal notranslate"><span class="pre">toml</span></code>. These differences are relevant to
understanding the amount of breakage we could expect if we used the <code class="docutils literal notranslate"><span class="pre">toml</span></code>
name for the standard library module, as well as to better understand the design
space. Note that this list might not be exhaustive.</p>
<ol class="arabic">
<li>This PEP currently proposes not to include a write API. That is, there will
be no equivalent of <code class="docutils literal notranslate"><span class="pre">toml.dump</span></code> or <code class="docutils literal notranslate"><span class="pre">toml.dumps</span></code>.<p>Discussed at <a class="reference internal" href="#including-an-api-for-writing-toml">including an api for writing toml</a>.</p>
<p>If we included a write API, it would be relatively simple to convert most
code that uses <code class="docutils literal notranslate"><span class="pre">toml</span></code> to use the API proposed in this PEP (acknowledging
that that is very different from a compatible API).</p>
<p>A significant fraction of <code class="docutils literal notranslate"><span class="pre">toml</span></code> users rely on this, based on comparing
<a class="reference external" href="https://grep.app/search?q=toml.load&amp;filter[lang][0]=Python">occurrences of “toml.load”</a>
to <a class="reference external" href="https://grep.app/search?q=toml.dump&amp;filter[lang][0]=Python">occurences of “toml.dump”</a>.</p>
</li>
<li>Different first argument of <code class="docutils literal notranslate"><span class="pre">toml.load</span></code><p><code class="docutils literal notranslate"><span class="pre">toml.load</span></code> has the following signature:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load</span><span class="p">(</span>
    <span class="n">f</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">SupportsRead</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">PathLike</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">bytes</span><span class="p">]],</span>
    <span class="n">_dict</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
    <span class="n">decoder</span><span class="p">:</span> <span class="n">TomlDecoder</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span> <span class="o">...</span>
</pre></div>
</div>
<p>This is pretty different from the first argument proposed in this PEP: <code class="docutils literal notranslate"><span class="pre">SupportsRead[bytes]</span></code>.</p>
<p>Recapping the reasons for this, previously mentioned at
<a class="reference internal" href="#types-accepted-by-the-first-argument-of-tomllib-load">types accepted by the first argument of tomllib.load</a>:</p>
<ul class="simple">
<li>Allowing passing of paths (and lists of path-like objects, ignoring missing
files and merging the documents into a single object) is inconsistent with
other similar functions in the standard library.</li>
<li>Using <code class="docutils literal notranslate"><span class="pre">SupportsRead[bytes]</span></code> allows us to a) ensure utf-8 is the encoding used,
b) avoid incorrectly parsing single carriage returns as valid TOML due to
universal newlines. TOML specifies file encoding and valid newline
sequences, and hence is simply stricter format than what text file objects
represent.</li>
</ul>
<p>A significant fraction of <code class="docutils literal notranslate"><span class="pre">toml</span></code> users rely on this, based on manual inspection
of <a class="reference external" href="https://grep.app/search?q=toml.load&amp;filter[lang][0]=Python">occurrences of “toml.load”</a>.</p>
</li>
<li>Errors<p><code class="docutils literal notranslate"><span class="pre">toml</span></code> raises <code class="docutils literal notranslate"><span class="pre">TomlDecodeError</span></code> vs the proposed <a class="reference external" href="pep-0008.html">PEP 8</a> compliant
<code class="docutils literal notranslate"><span class="pre">TOMLDecodeError</span></code>.</p>
<p>A significant fraction of <code class="docutils literal notranslate"><span class="pre">toml</span></code> users rely on this, based on <a class="reference external" href="https://grep.app/search?q=TomlDecodeError&amp;case=true&amp;filter[lang][0]=Python">occurrences
of “TomlDecodeError”</a>.</p>
</li>
<li><code class="docutils literal notranslate"><span class="pre">toml.load[s]</span></code> accepts a <code class="docutils literal notranslate"><span class="pre">_dict</span></code> argument<p>Discussed at <a class="reference internal" href="#controlling-the-type-of-mappings-returned-by-tomllib-load-s">controlling the type of mappings returned by tomllib.load[s]</a>.</p>
<p>As discussed, almost all usage consists of <code class="docutils literal notranslate"><span class="pre">_dict=OrderedDict</span></code>, which is
not necessary in Python 3.7 and later.</p>
</li>
<li><code class="docutils literal notranslate"><span class="pre">toml.load[s]</span></code> support an undocumented <code class="docutils literal notranslate"><span class="pre">decoder</span></code> argument<p>It seems the intended use case is for an implementation of comment
preservation. The information recorded is not sufficient to roundtrip the
TOML document preserving style, the implementation has known bugs, the
feature is undocumented and I could only find one instance of its use on
<a class="reference external" href="https://grep.app">https://grep.app</a>.</p>
<p>The <a class="reference external" href="https://github.com/uiri/toml/blob/3f637dba5f68db63d4b30967fedda51c82459471/toml/decoder.pyi#L36">toml.TomlDecoder interface</a>
exposed is not simple, containing nine methods.</p>
<p>Users are probably better served by a more complete implementation of style
preserving parsing and writing.</p>
</li>
<li><code class="docutils literal notranslate"><span class="pre">toml.dump[s]</span></code> support an <code class="docutils literal notranslate"><span class="pre">encoder</span></code> argument<p>Note that we currently propose not to include a write API, however if that
were to change, these differences would likely become relevant.</p>
<p>This enables two use cases, a) control over how custom types should be
serialized, b) control over how output should be formatted.</p>
<p>The first use case is reasonable, however, I could only find two instances of
this on <a class="reference external" href="https://grep.app">https://grep.app</a>. One of these two instances used this ability to add
support for dumping <code class="docutils literal notranslate"><span class="pre">decimal.Decimal</span></code> (which a potential standard library
implementation would support out of the box).</p>
<p>If needed, this use case could be well served by the equivalent of the
<code class="docutils literal notranslate"><span class="pre">default</span></code> argument in <code class="docutils literal notranslate"><span class="pre">json.dump</span></code>.</p>
<p>The second use case is enabled by allowing users to specify subclasses of
<a class="reference external" href="https://github.com/uiri/toml/blob/3f637dba5f68db63d4b30967fedda51c82459471/toml/encoder.pyi#L9">toml.TomlEncoder</a>
and overriding methods to specify parts of the TOML writing process. The API
consists of five methods and exposes a lot of implementation detail.</p>
<p>There is some usage of the <code class="docutils literal notranslate"><span class="pre">encoder</span></code> API on <a class="reference external" href="https://grep.app">https://grep.app</a>, however, it
likely accounts for a tiny fraction of overall usage of <code class="docutils literal notranslate"><span class="pre">toml</span></code>.</p>
</li>
<li>Timezones<p><code class="docutils literal notranslate"><span class="pre">toml</span></code> uses and exposes custom <code class="docutils literal notranslate"><span class="pre">toml.tz.TomlTz</span></code> timezone objects. The
proposed implementation uses <code class="docutils literal notranslate"><span class="pre">datetime.timezone</span></code> objects from the standard
library.</p>
</li>
</ol>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright">Copyright</a></h2>
<p>This document is placed in the public domain or under the
CC0-1.0-Universal license, whichever is more permissive.</p>
</section>
</section>
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/pep-0680.rst">https://github.com/python/peps/blob/main/pep-0680.rst</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/pep-0680.rst">2022-01-12 10:57:51 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <h2>Contents</h2>
            <ul>
<li><a class="reference internal" href="#">PEP 680 – tomllib: Support for Parsing TOML in the Standard Library</a><ul>
<li><a class="reference internal" href="#contents">Contents</a></li>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#specification">Specification</a></li>
<li><a class="reference internal" href="#maintenance-implications">Maintenance Implications</a><ul>
<li><a class="reference internal" href="#stability-of-toml">Stability of TOML</a></li>
<li><a class="reference internal" href="#maintainability-of-proposed-implementation">Maintainability of proposed implementation</a></li>
<li><a class="reference internal" href="#toml-support-a-slippery-slope-for-other-things">TOML support a slippery slope for other things</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#security-implications">Security Implications</a></li>
<li><a class="reference internal" href="#how-to-teach-this">How to Teach This</a></li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
<li><a class="reference internal" href="#rejected-ideas">Rejected Ideas</a><ul>
<li><a class="reference internal" href="#basing-on-another-toml-implementation">Basing on another TOML implementation</a></li>
<li><a class="reference internal" href="#including-an-api-for-writing-toml">Including an API for writing TOML</a></li>
<li><a class="reference internal" href="#assorted-api-details">Assorted API details</a><ul>
<li><a class="reference internal" href="#types-accepted-by-the-first-argument-of-tomllib-load">Types accepted by the first argument of <code class="docutils literal notranslate"><span class="pre">tomllib.load</span></code></a></li>
<li><a class="reference internal" href="#type-accepted-by-the-first-argument-of-tomllib-loads">Type accepted by the first argument of <code class="docutils literal notranslate"><span class="pre">tomllib.loads</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#controlling-the-type-of-mappings-returned-by-tomllib-load-s">Controlling the type of mappings returned by <code class="docutils literal notranslate"><span class="pre">tomllib.load[s]</span></code></a></li>
<li><a class="reference internal" href="#removing-support-for-parse-float-in-tomllib-load-s">Removing support for <code class="docutils literal notranslate"><span class="pre">parse_float</span></code> in <code class="docutils literal notranslate"><span class="pre">tomllib.load[s]</span></code></a></li>
<li><a class="reference internal" href="#alternative-names-for-module">Alternative names for module</a></li>
</ul>
</li>
<li><a class="reference internal" href="#previous-discussion">Previous Discussion</a></li>
<li><a class="reference internal" href="#appendix-a-differences-between-proposed-api-and-toml">Appendix A: Differences between proposed API and <code class="docutils literal notranslate"><span class="pre">toml</span></code></a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</li>
</ul>

            <br />
            <strong id="source"><a href="https://github.com/python/peps/blob/main/pep-0680.rst">Page Source (GitHub)</a></strong>
        </nav>
    </section>
</body>
</html>